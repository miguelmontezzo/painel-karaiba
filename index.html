<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Painel Gerencial - Karaíba</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --red:#C62828; --red-700:#B71C1C; --green:#2E7D32; --blue:#1E88E5;
      --bg:#f6f7fb; --card:#ffffff; --text:#0f172a; --muted:#667085; --border:#e6e8ef;
    }
    
    /* RESET E BASE - MOBILE FIRST */
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;padding:0}
    body{background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--text);font-size:14px;line-height:1.4}
    
    /* CONTAINER RESPONSIVO */
    .container{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:16px; /* Mais espaçamento inicial */
    }
    
    /* BARRA SUPERIOR */
    .bar{
      background:var(--red);
      color:#fff;
      padding:16px;
      display:flex;
      align-items:center;
      gap:12px;
      position:sticky;
      top:0;
      z-index:100;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      min-height:80px;
      flex-wrap:nowrap;
      overflow:hidden;
    }
    
    /* AÇÕES DA BARRA */
    .bar-actions{
      display:flex;
      align-items:center;
      gap:12px;
      margin-left:auto;
    }
    
    /* BOTÃO DE LOGOUT */
    .logout-btn{
      background:rgba(255,255,255,0.1);
      border:1px solid rgba(255,255,255,0.3);
      color:#fff;
      padding:8px 12px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      gap:6px;
      backdrop-filter:blur(10px);
    }
    
    .logout-btn:hover{
      background:rgba(255,255,255,0.2);
      border-color:rgba(255,255,255,0.4);
      transform:translateY(-1px);
    }
    
    .logout-btn:active{
      transform:translateY(0);
    }
    .logo{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg,#ff8a80, #ff5252);
      background-image:url('https://i.ibb.co/Q37KgBh3/Ativo-1-2x.png');
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      flex-shrink:0;
    }
    .bar-text{
      flex:1;
      min-width:0;
      margin-right:12px;
      overflow:hidden;
    }
    .bar-text strong{
      display:block;
      font-size:18px;
      font-weight:700;
      margin-bottom:4px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .bar-text div{
      font-size:13px;
      opacity:0.9;
      line-height:1.3;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    
    /* PILL STATUS */
    .pill{
      padding:8px 14px;
      border-radius:20px;
      background:rgba(255,255,255,0.2);
      color:#fff;
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      flex-shrink:0;
      backdrop-filter:blur(10px);
      border:1px solid rgba(255,255,255,0.3);
    }
    
    /* TABS MOBILE */
    .tabs{
      display:flex;
      gap:6px;
      margin:16px 0 12px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:4px;
    }
    .tab{
      border:1px solid var(--border);
      background:#fff;
      border-radius:8px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:600;
      color:var(--muted);
      white-space:nowrap;
      font-size:14px;
      transition:all 0.2s ease;
    }
    .tab.active{
      background:#fff3f3;
      border-color:#ffd6d6;
      color:var(--red-700);
    }
    
    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:24px; /* Mais padding interno para respiro */
      margin-bottom:24px; /* Mais espaçamento entre cards */
      box-shadow:0 2px 8px rgba(16,24,40,.05);
    }
    
    /* FILTROS - MOBILE FIRST */
    .filters.card{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
      padding:20px;
    }
    .filters.card label{
      display:block;
      font-weight:700;
      color:var(--text);
      margin-bottom:8px;
      font-size:14px;
    }
    .filters.card input,
    .filters.card select{
      width:100%;
      padding:16px 14px;
      border:2px solid var(--border);
      border-radius:12px;
      font-size:16px;
      background:#fff;
      appearance:none;
      -webkit-appearance:none;
      transition:all 0.2s ease;
      min-height:56px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    .filters.card input:focus,
    .filters.card select:focus{
      outline:none;
      border-color:var(--red);
      box-shadow:0 0 0 3px rgba(198,40,40,0.1);
      transform:scale(1.02);
    }
    .filters.card select{
      background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
      background-position:right 12px center;
      background-repeat:no-repeat;
      background-size:16px;
      padding-right:40px;
    }
    
    /* KPIs - MOBILE */
    .kpis{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px; /* Mais gap entre KPIs */
      margin:24px 0; /* Mais margem vertical */
    }
    .kpi h3{
      margin:0 0 12px; /* Mais espaçamento entre título e valor */
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    .kpi .val{
      font-weight:800;
      font-size:20px;
      color:var(--text);
      margin-bottom:4px; /* Espaçamento inferior para respiro */
    }
    
    /* GRID LAYOUTS */
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap:20px; /* Gap otimizado para mobile */
      width:100%;
      overflow:hidden; /* Evita overflow horizontal */
    }
    
    /* TABELAS MOBILE FLUIDAS */
    .table-container{
      position:relative;
      overflow:hidden;
      margin:-16px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
      max-height:350px; /* Altura padrão para mobile */
    }
    
    /* ALTURAS ESPECÍFICAS PARA DIFERENTES TABELAS */
    .table-container.table-produtos{
      max-height:350px;
    }
    
    .table-container.table-pedidos{
      max-height:360px;
    }
    
    /* WRAPPER DE SCROLL HORIZONTAL E VERTICAL */
    .table-scroll{
      overflow-x:auto;
      overflow-y:auto; /* Permitir scroll vertical também */
      -webkit-overflow-scrolling:touch;
      padding:0;
      position:relative;
      max-height:400px; /* Altura máxima para ativar scroll */
    }
    
    /* INDICADORES VISUAIS DE SCROLL */
    .table-scroll::before{
      content:'';
      position:absolute;
      top:0;
      right:0;
      bottom:0;
      width:30px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.9));
      pointer-events:none;
      z-index:3;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    .table-scroll.has-more::before{
      opacity:1;
    }
    
    /* BARRA DE SCROLL CUSTOMIZADA */
    .table-scroll::-webkit-scrollbar{
      height:12px;
    }
    .table-scroll::-webkit-scrollbar-track{
      background:#f1f5f9;
      border-radius:6px;
      margin:0 8px;
    }
    .table-scroll::-webkit-scrollbar-thumb{
      background:var(--red);
      border-radius:6px;
      border:2px solid #f1f5f9;
    }
    .table-scroll::-webkit-scrollbar-thumb:hover{
      background:#B71C1C;
    }
    
    /* TABELA RESPONSIVA */
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px; /* Fonte menor para mobile */
      min-width:600px; /* Largura mínima reduzida */
      background:#fff;
      border-radius:12px;
      overflow:hidden;
    }
    
    /* CABEÇALHOS FIXOS */
    th{
      background:var(--red);
      color:#fff;
      font-weight:700;
      position:sticky;
      top:0;
      z-index:2;
      padding:16px 12px; /* Mais padding para respiro */
      text-align:left;
      text-transform:uppercase;
      font-size:11px; /* Fonte menor para mobile */
      letter-spacing:0.3px;
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
      border-bottom:none;
      line-height:1.4; /* Mais altura de linha */
    }
    
    /* PRIMEIRA COLUNA FIXA */
    th:first-child,
    td:first-child{
      position:sticky;
      left:0;
      z-index:1;
      box-shadow:2px 0 4px rgba(0,0,0,0.1);
    }
    th:first-child{
      z-index:3;
      border-top-left-radius:12px;
    }
    
    /* CÉLULAS DE DADOS */
    td{
      background:#fff;
      padding:16px 12px; /* Mais padding para respiro */
      border-bottom:1px solid #e2e8f0;
      font-size:13px; /* Fonte menor para mobile */
      color:var(--text);
      vertical-align:middle;
      line-height:1.5; /* Mais altura de linha para respiro */
      word-wrap:break-word; /* Quebra palavras longas */
      max-width:150px; /* Largura máxima para controlar colunas */
    }
    
    /* LINHAS ALTERNADAS */
    tr:nth-child(even) td{
      background:#f8fafc;
    }
    tr:nth-child(even) td:first-child{
      background:#f8fafc;
    }
    
    /* HOVER EFFECT */
    tr:hover td{
      background:#e0f2fe !important;
      transform:scale(1.01);
      transition:all 0.2s ease;
    }
    
    /* ÚLTIMA LINHA */
    tr:last-child td:first-child{
      border-bottom-left-radius:12px;
    }
    tr:last-child td:last-child{
      border-bottom-right-radius:12px;
    }
    
    /* COLUNAS ESPECÍFICAS */
    td:nth-child(6), /* Total - células de dados */
    th:nth-child(6){ /* Total - header */
      font-weight:700;
      text-align:right;
    }
    
    /* COR VERDE APENAS PARA CÉLULAS DE DADOS DA COLUNA TOTAL */
    td:nth-child(6){
      color:var(--green);
    }
    
    /* HEADER DA COLUNA TOTAL PERMANECE BRANCO */
    th:nth-child(6){
      color:#fff;
    }
    
    /* INDICADOR DE SCROLL */
    .scroll-indicator{
      position:absolute;
      bottom:8px;
      right:16px;
      background:var(--red);
      color:#fff;
      padding:6px 12px;
      border-radius:20px;
      font-size:11px;
      font-weight:600;
      z-index:4;
      opacity:0;
      transition:opacity 0.3s ease;
    }
    .table-container.scrollable .scroll-indicator{
      opacity:1;
    }
    
    /* BOTÕES */
    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:2px solid var(--border);
      background:#fff;
      border-radius:8px; /* Menor no mobile */
      padding:10px 14px; /* Padding menor para mobile */
      cursor:pointer;
      font-size:13px; /* Fonte menor no mobile */
      font-weight:600;
      transition:all 0.2s ease;
      white-space:nowrap;
      min-height:40px; /* Altura menor no mobile */
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      touch-action:manipulation;
      flex-shrink:0; /* Evita compressão */
    }
    .btn:hover{
      background:#f8f9fa;
      border-color:#ddd;
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .btn:active{
      transform:translateY(0);
      box-shadow:0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* CARDS DE PEDIDOS */
    .pedidos-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:20px; /* Mais gap entre cards de pedidos */
      margin-top:24px; /* Mais margem superior */
    }
    
    .pedido-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      padding:24px; /* Mais padding interno para respiro */
      box-shadow:0 2px 8px rgba(16,24,40,.06);
      transition:all 0.3s ease;
      position:relative;
    }
    
    .pedido-card:hover{
      box-shadow:0 8px 24px rgba(16,24,40,.12);
      border-color:#ddd;
      transform:translateY(-2px);
    }
    
    .card-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:16px;
    }
    
    .pedido-info-top{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    
    .pedido-time{
      background:#f0f9ff;
      color:#0369a1;
      font-weight:700;
      font-family:monospace;
      font-size:14px;
      padding:6px 12px;
      border-radius:8px;
      letter-spacing:0.5px;
    }
    
    .pedido-numero{
      background:#f1f5f9;
      color:#475569;
      font-weight:600;
      font-size:12px;
      padding:4px 8px;
      border-radius:6px;
      letter-spacing:0.3px;
    }
    
    .pedido-value{
      background:#f0fdf4;
      color:#166534;
      font-weight:800;
      font-size:20px;
      padding:12px 20px;
      border-radius:12px;
      border:2px solid #bbf7d0;
      text-align:center;
      margin-bottom:16px;
    }
    
    .pedido-cliente{
      font-size:16px;
      font-weight:700;
      color:var(--text);
      margin-bottom:8px; /* Mais espaçamento após nome do cliente */
    }
    
    .pedido-info{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px; /* Mais gap entre informações */
      margin-bottom:20px; /* Mais espaçamento após info */
    }
    
    .info-item{
      display:flex;
      flex-direction:column;
      gap:6px; /* Mais gap entre label e value */
    }
    
    .info-label{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    .info-value{
      font-size:14px;
      color:var(--text);
      font-weight:500;
    }
    
    .status-container{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:flex-end;
    }
    
    .pedido-status{
      padding:6px 12px;
      border-radius:12px;
      font-size:11px;
      font-weight:700;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:0.3px;
      text-align:center;
      min-width:80px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      flex-shrink:0;
    }
    
    .pedido-tipo{
      padding:4px 8px;
      border-radius:8px;
      font-size:10px;
      font-weight:600;
      background:#f1f5f9;
      color:#475569;
      text-transform:uppercase;
      letter-spacing:0.3px;
      text-align:center;
      border:1px solid #e2e8f0;
      min-width:60px;
    }
    
    .status-entregue{background:#2E7D32}
    .status-pendente{background:#FF9800}
    .status-preparando{background:#1E88E5}
    .status-cancelado{background:#C62828}
    .status-confirmado{background:#4CAF50}
    .status-em-preparo{background:#2196F3}
    .status-pronto{background:#9C27B0}
    .status-saiu-para-entrega{background:#FF5722}
    .status-finalizado{background:#4CAF50}
    
    /* AÇÕES DOS PEDIDOS */
    .pedido-actions{
      display:flex;
      gap:8px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid var(--border);
    }
    
    .btn-action{
      flex:1;
      padding:8px 12px;
      border:1px solid;
      border-radius:8px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s ease;
      text-align:center;
    }
    
    .btn-confirmar{
      background:#f0fdf4;
      color:#166534;
      border-color:#bbf7d0;
    }
    
    .btn-confirmar:hover:not(:disabled){
      background:#dcfce7;
      border-color:#86efac;
      transform:translateY(-1px);
    }
    
    .btn-entrega{
      background:#eff6ff;
      color:#1d4ed8;
      border-color:#bfdbfe;
    }
    
    .btn-entrega:hover:not(:disabled){
      background:#dbeafe;
      border-color:#93c5fd;
      transform:translateY(-1px);
    }
    
    .btn-action:disabled{
      opacity:0.6;
      cursor:not-allowed;
      transform:none !important;
    }
    
    /* HEADER DOS PEDIDOS */
    .pedidos-header{
      display:none;
      grid-template-columns:80px 1fr 120px 100px 80px 120px;
      gap:16px;
      padding:12px 20px;
      background:#f8f9fa;
      border-radius:12px;
      margin-bottom:8px;
      font-size:11px;
      font-weight:700;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    
    /* SEÇÃO HEADER */
    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start; /* Melhor alinhamento no mobile */
      margin-bottom:20px;
      gap:12px;
      min-height:44px; /* Altura mínima para botões */
    }
    .section-header strong{
      font-size:16px;
      color:var(--text);
      flex:1; /* Ocupa espaço disponível */
      line-height:1.4;
    }
    .section-controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      flex-shrink:0; /* Impede compressão */
    }
    
    /* SEARCH INPUT */
    .search-container{
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    #search{
      flex:1;
      min-width:280px;
      padding:16px 20px;
      border:2px solid var(--border);
      border-radius:12px;
      font-size:16px;
      background:#fff;
      min-height:56px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
      transition:all 0.2s ease;
    }
    #search:focus{
      outline:none;
      border-color:var(--red);
      box-shadow:0 0 0 3px rgba(198,40,40,0.1);
      transform:scale(1.02);
    }
    #search::placeholder{
      color:var(--muted);
      font-size:15px;
    }
    
    /* BREAKPOINTS MOBILE EXTRA SMALL */
    @media(max-width:320px){
      .bar{
        padding:10px;
        gap:6px;
        min-height:65px;
      }
      .logo{
        width:28px;
        height:28px;
      }
      .bar-text{
        margin-right:6px;
      }
      .bar-text strong{
        font-size:13px;
        margin-bottom:1px;
      }
      .bar-text div{
        font-size:10px;
      }
      .pill{
        padding:3px 6px;
        font-size:10px;
      }
      .logout-btn{
        padding:5px 6px;
        font-size:11px;
      }
      /* Cards dos pedidos em mobile extra pequeno */
      .pedidos-grid{
        gap:10px;
        margin-top:12px;
      }
      .pedido-card{
        padding:14px;
      }
      .card-top{
        margin-bottom:12px;
        flex-direction:column;
        gap:8px;
        align-items:flex-start;
      }
      .pedido-time{
        font-size:11px;
        padding:3px 6px;
      }
      .pedido-value{
        font-size:16px;
        padding:8px 12px;
        margin-bottom:12px;
      }
      .pedido-cliente{
        font-size:13px;
        margin-bottom:10px;
      }
      .pedido-info{
        grid-template-columns:1fr;
        gap:8px;
        margin-bottom:12px;
      }
      .info-label{
        font-size:9px;
      }
      .info-value{
        font-size:12px;
      }
      .pedido-status{
        padding:4px 8px;
        font-size:9px;
        min-width:50px;
      }
      .status-main{
        font-size:9px;
        margin-bottom:1px;
      }
      .status-tipo{
        font-size:7px;
      }
      .pedido-numero{
        font-size:10px;
        padding:3px 6px;
      }
      .pedido-actions{
        margin-top:12px;
        padding-top:12px;
        gap:6px;
      }
      .btn-action{
        padding:6px 8px;
        font-size:10px;
      }
    }
    
    /* BREAKPOINTS MOBILE SMALL */
    @media(max-width:375px){
      .container{padding:12px} /* Padding menor em telas pequenas */
      .card{padding:16px; margin-bottom:16px} /* Cards mais compactos */
      .bar{
        padding:12px;
        gap:8px;
        min-height:70px;
      }
      .logo{
        width:32px;
        height:32px;
      }
      .bar-text{
        margin-right:8px;
      }
      .bar-text strong{
        font-size:14px;
        margin-bottom:2px;
      }
      .bar-text div{
        font-size:11px;
      }
      .pill{
        padding:4px 8px;
        font-size:11px;
      }
      .logout-btn{
        padding:6px 8px;
        font-size:12px;
        min-width:auto;
      }
      .logout-text{display:none} /* Esconder texto no mobile pequeno */
      .section-header{margin-bottom:16px}
      .section-header strong{font-size:15px}
      .btn{
        padding:8px 12px; /* Botões menores */
        font-size:12px;
        min-height:36px;
      }
      .table-container{
        max-height:300px; /* Altura menor */
      }
      .table-scroll{
        max-height:300px;
      }
      table{
        font-size:12px;
        min-width:480px; /* Largura menor */
      }
      th{
        padding:8px 6px;
        font-size:10px;
      }
      td{
        padding:8px 6px;
        font-size:12px;
        max-width:100px;
      }
      .chart-section{
        margin-bottom:16px;
      }
      .chart-table-grid{
        gap:16px;
      }
      /* Cards dos pedidos em mobile pequeno */
      .pedidos-grid{
        gap:12px;
        margin-top:16px;
      }
      .pedido-card{
        padding:16px;
      }
      .card-top{
        margin-bottom:12px;
        flex-direction:column;
        gap:8px;
        align-items:flex-start;
      }
      .pedido-time{
        font-size:12px;
        padding:4px 8px;
      }
      .pedido-value{
        font-size:18px;
        padding:10px 16px;
        border-width:1px;
        margin-bottom:12px;
      }
      .pedido-cliente{
        font-size:14px;
        margin-bottom:12px;
      }
      .pedido-info{
        grid-template-columns:1fr;
        gap:12px;
        margin-bottom:16px;
      }
      .info-item{
        gap:4px;
      }
      .info-label{
        font-size:10px;
      }
      .info-value{
        font-size:13px;
      }
      .pedido-status{
        padding:5px 10px;
        font-size:10px;
        min-width:55px;
      }
      .status-main{
        font-size:10px;
        margin-bottom:1px;
      }
      .status-tipo{
        font-size:8px;
      }
      .pedido-numero{
        font-size:11px;
        padding:3px 6px;
      }
      .pedido-actions{
        margin-top:14px;
        padding-top:12px;
        gap:6px;
      }
      .btn-action{
        padding:7px 10px;
        font-size:11px;
      }
    }
    
    /* BREAKPOINTS MOBILE LARGE */
    @media(min-width:376px) and (max-width:639px){
      .container{padding:16px}
      .card{padding:20px; margin-bottom:20px}
      .bar{
        padding:14px 16px;
        gap:10px;
        min-height:75px;
      }
      .logo{
        width:36px;
        height:36px;
      }
      .bar-text strong{font-size:16px}
      .section-header{margin-bottom:18px}
      .btn{
        padding:10px 14px;
        font-size:13px;
        min-height:40px;
      }
      .table-container{
        max-height:350px;
      }
      .table-scroll{
        max-height:350px;
      }
      table{
        min-width:520px;
      }
      td{
        max-width:130px;
      }
      .chart-section{
        margin-bottom:18px;
      }
      .chart-table-grid{
        gap:18px;
      }
      /* Cards dos pedidos em mobile médio */
      .pedidos-grid{
        gap:16px;
        margin-top:20px;
      }
      .pedido-card{
        padding:20px;
      }
      .card-top{
        margin-bottom:14px;
      }
      .pedido-time{
        font-size:13px;
        padding:5px 10px;
      }
      .pedido-value{
        font-size:19px;
        padding:10px 16px;
        margin-bottom:14px;
      }
      .pedido-cliente{
        font-size:15px;
        margin-bottom:14px;
      }
      .pedido-info{
        gap:14px;
        margin-bottom:18px;
      }
      .info-label{
        font-size:10px;
      }
      .info-value{
        font-size:13px;
      }
      .pedido-status{
        padding:6px 10px;
        font-size:11px;
        min-width:58px;
      }
      .status-main{
        font-size:11px;
        margin-bottom:1px;
      }
      .status-tipo{
        font-size:9px;
      }
      .pedido-numero{
        font-size:11px;
        padding:4px 7px;
      }
      .pedido-actions{
        margin-top:16px;
        padding-top:14px;
        gap:8px;
      }
      .btn-action{
        padding:8px 12px;
        font-size:12px;
      }
    }
    
    /* BREAKPOINTS TABLET */
    @media(min-width:640px){
      .container{padding:20px}
      .card{padding:24px; margin-bottom:24px}
      .filters.card{grid-template-columns:1fr 1fr}
      .kpis{grid-template-columns:repeat(4,1fr)}
      .pedidos-grid{grid-template-columns:1fr 1fr}
      .logo{width:40px;height:40px}
      .kpi .val{font-size:24px}
      .bar{padding:16px 24px}
      .bar-text strong{font-size:20px}
      .btn{
        padding:12px 16px;
        font-size:14px;
        min-height:44px;
      }
      .section-header{
        margin-bottom:20px;
      }
      .grid{
        gap:24px;
      }
    }
    
    /* BREAKPOINTS TABLET LARGE */
    @media(min-width:768px){
      .grid{grid-template-columns:1fr 1fr}
      .filters.card{grid-template-columns:repeat(3,1fr)}
      table{
        min-width:auto;
        font-size:14px; /* Fonte normal no desktop */
      }
      .table-container{
        margin:0;
        padding:0;
        box-shadow:0 2px 8px rgba(0,0,0,0.1);
        max-height:500px; /* Altura adequada para desktop com scroll */
      }
      .table-container.table-produtos{
        max-height:500px;
      }
      .table-container.table-pedidos{
        max-height:550px; /* Altura maior para tabela de pedidos */
      }
      .table-scroll{
        max-height:500px; /* Altura adequada para desktop */
        overflow-y:auto; /* Mantém scroll vertical no desktop */
      }
      .scroll-indicator{
        display:none;
      }
      .table-scroll::before{
        display:none;
      }
      th{
        padding:16px 12px; /* Padding normal no desktop */
        font-size:12px; /* Fonte normal no desktop */
        position:sticky; /* Mantém sticky no topo para desktop */
        top:0; /* Fica fixo no topo durante scroll vertical */
      }
      td{
        padding:16px 12px; /* Padding normal no desktop */
        font-size:14px; /* Fonte normal no desktop */
        max-width:none; /* Remove limitação de largura */
      }
      th:first-child,
      td:first-child{
        position:static;
        box-shadow:none;
      }
      .filters.card input,
      .filters.card select{
        padding:12px 14px;
        min-height:48px;
      }
      #search{
        min-width:200px;
        padding:12px 16px;
        min-height:48px;
      }
    }
    
    /* BREAKPOINTS DESKTOP */
    @media(min-width:950px){
      .filters.card{grid-template-columns:repeat(5,1fr)}
      .pedidos-grid{grid-template-columns:repeat(3,1fr)}
    }
    
    /* BREAKPOINTS LARGE DESKTOP */
    @media(min-width:1200px){
      .pedidos-grid{grid-template-columns:repeat(4,1fr)}
    }
    
    /* HIDDEN/SHOW UTILITIES */
    .mobile-only{display:block}
    .desktop-only{display:none}
    
    @media(min-width:768px){
      .mobile-only{display:none}
      .desktop-only{display:block}
    }
    
        /* CHART CONTAINERS */
    .chart-container{
      height:280px; /* Altura otimizada sem título interno */
      width:100%;
    }

    @media(min-width:640px){
      .chart-container{height:300px} /* Altura maior em tablet */
    }
    
    @media(min-width:950px){
      .chart-container{height:320px} /* Altura maior em desktop */
    }
    
    /* SEÇÕES DE CHART E TABLE */
    .chart-section{
      margin-bottom:20px; /* Espaçamento otimizado para mobile */
    }
    
    .table-section{
      margin-top:0; /* Remove margem adicional */
    }
    
    /* GRID CHART-TABLE ESPECÍFICO */
    .chart-table-grid{
      gap:20px; /* Gap otimizado para mobile */
      display:grid;
      grid-template-columns:1fr; /* Uma coluna no mobile */
    }
    
    @media(min-width:768px){
      .chart-section{
        margin-bottom:0; /* Remove margem no desktop */
      }
      .chart-table-grid{
        gap:24px; /* Gap para desktop */
        grid-template-columns:1fr 1fr; /* Duas colunas no desktop */
      }
    }
    
    /* MELHORIAS ESPECÍFICAS MOBILE */
    .card{
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    
    /* IOS SPECIFIC */
    input[type="date"],
    input[type="text"],
    select{
      -webkit-appearance:none;
      -webkit-border-radius:12px;
    }
    
    /* LOADING STATES */
    .loading{
      opacity:0.6;
      pointer-events:none;
      position:relative;
    }
    .loading::after{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:20px;
      height:20px;
      margin:-10px 0 0 -10px;
      border:2px solid var(--border);
      border-radius:50%;
      border-top-color:var(--red);
      animation:spin 1s ease-in-out infinite;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    /* SCROLL BARS MOBILE */
    .table-container::-webkit-scrollbar{
      height:8px;
    }
    .table-container::-webkit-scrollbar-track{
      background:#f1f1f1;
      border-radius:4px;
    }
    .table-container::-webkit-scrollbar-thumb{
      background:#c1c1c1;
      border-radius:4px;
    }
    .table-container::-webkit-scrollbar-thumb:hover{
      background:#a8a8a8;
    }
    
    /* PULL TO REFRESH INDICATOR */
    .refresh-indicator{
      text-align:center;
      padding:20px;
      color:var(--muted);
      font-size:14px;
      background:linear-gradient(to bottom, var(--bg), transparent);
    }
    
    /* ACCESSIBILITY */
    @media(prefers-reduced-motion:reduce){
      *{transition:none!important;animation:none!important}
    }
    
    /* HIGH CONTRAST */
    @media(prefers-contrast:high){
      .btn{border-width:3px}
      .filters.card input,
      .filters.card select{border-width:3px}
    }
    
    /* MODAL STYLES */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from { 
        opacity: 0;
        transform: scale(0.9) translateY(-20px);
      }
      to { 
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    .modal-content {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
      animation: slideIn 0.3s ease-out;
      overflow: hidden;
    }
    
    .modal-header {
      padding: 24px 24px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .modal-header h3 {
      margin: 0 0 16px 0;
      font-size: 20px;
      font-weight: 700;
      color: #1e293b;
    }
    
    .modal-body {
      padding: 20px 24px;
    }
    
    .modal-body p {
      margin: 0;
      font-size: 16px;
      color: #64748b;
      line-height: 1.5;
    }
    
    .modal-footer {
      padding: 0 24px 24px;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    .btn-cancel,
    .btn-confirm {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 80px;
    }
    
    .btn-cancel {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    
    .btn-cancel:hover {
      background: #e2e8f0;
      color: #334155;
    }
    
    .btn-confirm {
      background: #dc2626;
      color: #fff;
    }
    
    .btn-confirm:hover {
      background: #b91c1c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    
    /* RESPONSIVE MODAL */
    @media(max-width: 480px) {
      .modal-content {
        margin: 20px;
        width: calc(100% - 40px);
      }
      
      .modal-header,
      .modal-body,
      .modal-footer {
        padding-left: 20px;
        padding-right: 20px;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .btn-cancel,
      .btn-confirm {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="bar">
    <div class="logo"></div>
    <div class="bar-text">
      <strong>Painel de Pedidos • Karaíba</strong>
      <div>Visão clara para o delivery</div>
    </div>
    <div class="bar-actions">
      <div id="status" class="pill">Conectando…</div>
      <button id="logoutBtn" class="logout-btn" title="Sair">
        <span>👤</span>
        <span class="logout-text">Sair</span>
      </button>
    </div>
  </div>

  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">Dashboard</div>
      <div class="tab" data-tab="hoje">Pedidos de Hoje</div>
    </div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="tabpane">
      <section class="card filters">
        <div><label>Início</label><input id="start" type="date" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></div>
        <div><label>Fim</label><input id="end" type="date" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></div>
        <div><label>Bairro</label><select id="bairro" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"><option value="">Todos</option></select></div>
        <div><label>Pagamento</label><select id="pagamento" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"><option value="">Todas</option></select></div>
        <div><label>Status</label><select id="statusSel" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"><option value="">Todos</option></select></div>
      </section>

      <section class="kpis">
        <div class="card kpi"><h3>Pedidos</h3><div id="kpi-pedidos" class="val">—</div></div>
        <div class="card kpi"><h3>Faturamento</h3><div id="kpi-fat" class="val">—</div></div>
        <div class="card kpi"><h3>Ticket médio</h3><div id="kpi-ticket" class="val">—</div></div>
        <div class="card kpi"><h3>% Cartão (Crédito+Débito)</h3><div id="kpi-cartao" class="val">—</div></div>
      </section>

      <section class="grid">
        <div class="card">
          <div class="section-header">
            <strong>Pedidos por Dia</strong>
          </div>
          <div id="chart-pedidos" class="chart-container"></div>
        </div>
        <div class="card">
          <div class="section-header">
            <strong>Faturamento por Dia</strong>
          </div>
          <div id="chart-fat" class="chart-container"></div>
        </div>
        <div class="card">
          <div class="section-header">
            <strong>Pedidos por Bairro</strong>
          </div>
          <div id="chart-bairros" class="chart-container"></div>
        </div>
        <div class="card">
          <div class="section-header">
            <strong>Formas de Pagamento</strong>
          </div>
          <div id="chart-pagamento" class="chart-container"></div>
        </div>
      </section>

      <!-- SEÇÃO ITENS MAIS PEDIDOS -->
      <section class="card">
        <div class="section-header">
          <strong>Produtos Mais Pedidos</strong>
          <div class="section-controls">
            <button id="downloadItens" class="btn">📊 Baixar CSV</button>
          </div>
        </div>
        
        <div class="chart-section">
          <div id="chart-itens" class="chart-container" style="height:350px"></div>
        </div>
        
        <div class="table-section">
          <div class="table-container table-produtos">
            <div class="table-scroll">
              <table>
                <thead><tr>
                  <th>#</th><th>Item</th><th>Qtd</th><th>Receita</th>
                </tr></thead>
                <tbody id="tbodyItens"></tbody>
              </table>
            </div>
            <div class="scroll-indicator">👈 Deslize para ver mais</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="section-header">
          <strong>Pedidos (amostra filtrada)</strong>
          <div class="section-controls">
            <button id="download" class="btn">📄 Baixar CSV</button>
        </div>
        </div>
        <div class="table-section">
          <div class="table-container table-pedidos">
            <div class="table-scroll">
          <table>
                <thead><tr>
              <th>Data</th><th>Cliente</th><th>Bairro</th><th>Pagamento</th><th>Status</th><th>Total (R$)</th>
            </tr></thead>
            <tbody id="tbody"></tbody>
          </table>
            </div>
            <div class="scroll-indicator">👈 Deslize para ver mais</div>
          </div>
        </div>
      </section>
    </section>

    <!-- PEDIDOS DE HOJE -->
    <section id="hoje" class="tabpane" style="display:none">
      <section class="card">
        <div class="section-header">
          <strong>Pedidos de Hoje</strong>
                    <div class="section-controls">
            <span id="countHoje" class="pill" style="background:var(--green);color:#fff">0 pedidos</span>
            <button id="refreshHoje" class="btn">🔄 Atualizar</button>
        </div>
        </div>

        <div class="search-container">
          <input id="search" placeholder="Buscar cliente/bairro..."/>
        </div>
        
        <div class="pedidos-grid" id="listHoje"></div>
        
        <div id="emptyStateHoje" style="display:none;text-align:center;padding:60px 20px;color:var(--muted)">
          <div style="font-size:64px;margin-bottom:20px">📋</div>
          <div style="font-size:18px;margin-bottom:8px;font-weight:600">Nenhum pedido hoje</div>
          <div style="font-size:14px">Os pedidos aparecerão aqui quando chegarem</div>
        </div>

        <div style="color:var(--muted);font-size:12px;margin-top:12px;text-align:center">
          Atualiza automaticamente a cada 20s
        </div>
      </section>
    </section>



  </div>

  <!-- Modal de Confirmação de Logout -->
  <div id="logoutModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Confirmar Saída</h3>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja sair do sistema?</p>
      </div>
      <div class="modal-footer">
        <button id="cancelLogout" class="btn-cancel">Cancelar</button>
        <button id="confirmLogout" class="btn-confirm">Sair</button>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  const supabase = createClient("https://dbepscombakzdvruuxav.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZXBzY29tYmFremR2cnV1eGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODg5OTEsImV4cCI6MjA2Njk2NDk5MX0.vahd7AyhmuJ22EzpapV237jPQPh4UjL-gt6QMvVRozs", { db: { schema:'public' } });
  const SOURCE = "pedidos_karaiba";

  // Verificação de autenticação
  function checkAuth() {
    const user = localStorage.getItem('karaiba_user');
    if (!user) {
      window.location.href = '/login.html';
      return false;
    }
    
    try {
      const userData = JSON.parse(user);
      // Verificar se o login não expirou (24 horas)
      const loginTime = new Date(userData.loginTime);
      const now = new Date();
      const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
      
      if (hoursDiff > 24) {
        localStorage.removeItem('karaiba_user');
        window.location.href = '/login.html';
        return false;
      }
      
      return userData;
    } catch (error) {
      localStorage.removeItem('karaiba_user');
      window.location.href = '/login.html';
      return false;
    }
  }
  
  // Verificar autenticação ao carregar a página
  console.log('Verificando autenticação...');
  const currentUser = checkAuth();
  console.log('Resultado da autenticação:', currentUser);
  if (!currentUser) {
    console.log('Usuário não autenticado, redirecionando...');
  } else {
    console.log('Usuário autenticado, continuando...');
    initApp();
  }

  function initApp() {

  // Helpers
  const q = (s)=>document.querySelector(s);
  const currency = (v)=> (v==null||isNaN(v)) ? "—" : Number(v).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
  const todayStr = ()=> new Date().toISOString().slice(0,10);
  const toNum = (x)=> Number(String(x).replace('R$','').replace(' ','').replace(',','.'))||0;
  const normalize = (r)=> ({ ...r, valor_total: toNum(r.valor_total), taxa_entrega: toNum(r.taxa_entrega), data_hora_pedido: r.data_hora_pedido || r.created_at || r.data });
  const unique = (arr, key)=> [...new Set(arr.map(r=> (r[key]||'').trim()).filter(Boolean))].sort((a,b)=> a.localeCompare(b,'pt-BR'));
  const groupBy = (arr, keyFn, valFn, agg='sum')=> {
    const m=new Map();
    arr.forEach(it=>{ const k=keyFn(it), v=valFn(it); if(!m.has(k)) m.set(k,[]); m.get(k).push(v); });
    return [...m.entries()].map(([k,vals])=>({key:k, value: agg==='count'? vals.length : vals.reduce((a,b)=>a+(Number(b)||0),0)})).sort((a,b)=> a.key>b.key?1:-1);
  };

  // Tabs
  document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=> {
    document.querySelectorAll('.tab').forEach(x=> x.classList.remove('active'));
    t.classList.add('active');
    const id = t.dataset.tab;
    document.querySelectorAll('.tabpane').forEach(p=> p.style.display = (p.id===id? 'block':'none'));
  }));

  // Data state
  let DATA = [];
  let timerHoje = null;

  // Dashboard functions
  function hydrateFilters(){
    const bairros = unique(DATA,'bairro'), formas = unique(DATA,'forma_pagamento'), status = unique(DATA,'status');
    const selB = q('#bairro'), selP=q('#pagamento'), selS=q('#statusSel');
    selB.innerHTML = '<option value="">Todos</option>'; bairros.forEach(b=> selB.insertAdjacentHTML('beforeend', `<option>${b}</option>`));
    selP.innerHTML = '<option value="">Todas</option>'; formas.forEach(f=> selP.insertAdjacentHTML('beforeend', `<option>${f}</option>`));
    selS.innerHTML = '<option value="">Todos</option>'; status.forEach(s=> selS.insertAdjacentHTML('beforeend', `<option>${s}</option>`));
    const dates = DATA.map(d=> new Date(d.data_hora_pedido)); const minD = new Date(Math.min(...dates)); const maxD = new Date(Math.max(...dates));
    q('#start').value = minD.toISOString().slice(0,10); q('#end').value = maxD.toISOString().slice(0,10);
    ['start','end','bairro','pagamento','statusSel'].forEach(id=> q('#'+id).addEventListener('change', update));
  }
  function applyFilters(){
    const s=q('#start').value, e=q('#end').value, b=q('#bairro').value.trim(), p=q('#pagamento').value.trim(), st=q('#statusSel').value.trim();
    const start = s? new Date(s+'T00:00:00') : null, end = e? new Date(e+'T23:59:59') : null;
    return DATA.filter(r=>{
      const dt = new Date(r.data_hora_pedido);
      if(start && dt<start) return false; if(end && dt>end) return false;
      if(b && (r.bairro||'').trim()!==b) return false;
      if(p && (r.forma_pagamento||'').trim()!==p) return false;
      if(st && (r.status||'').trim()!==st) return false;
      return true;
    });
  }
  function renderKPIs(rows){
    const pedidos = rows.length;
    const fat = rows.reduce((a,r)=> a + (Number(r.valor_total)||0),0);
    const ticket = pedidos? fat/pedidos : 0;
    const cartao = rows.filter(r=> /(Crédito|Débito)/i.test(r.forma_pagamento||'')).length/(pedidos||1);
    q('#kpi-pedidos').textContent = pedidos.toLocaleString('pt-BR');
    q('#kpi-fat').textContent = currency(fat);
    q('#kpi-ticket').textContent = currency(ticket);
    q('#kpi-cartao').textContent = (cartao*100).toFixed(1)+'%';
  }
  function renderCharts(rows){
    const isMobile = window.innerWidth < 640;
    const isTablet = window.innerWidth < 768;
    
    // Configurações responsivas para gráficos
    const mobileConfig = {
      displayModeBar: false,
      responsive: true,
      modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    };
    
    const mobileLayout = {
      margin: { t: 20, l: 30, r: 20, b: 40 },
      paper_bgcolor: '#fff',
      plot_bgcolor: '#fff',
      font: { size: isMobile ? 10 : 12 }
    };
    
    // Gráfico de pedidos por dia
    const byDay = groupBy(rows, r=> String(r.data_hora_pedido).slice(0,10), _=>1, 'count');
    Plotly.newPlot('chart-pedidos', [{
      x: byDay.map(d => d.key),
      y: byDay.map(d => d.value),
      type: 'bar',
      marker: { color: '#1E88E5' }
    }], {
      ...mobileLayout,
      xaxis: { tickangle: isMobile ? -45 : -30, tickfont: { size: isMobile ? 9 : 11 } }
    }, mobileConfig);
    
    // Gráfico de faturamento
    const byDayFat = groupBy(rows, r=> String(r.data_hora_pedido).slice(0,10), r=> Number(r.valor_total)||0, 'sum');
    Plotly.newPlot('chart-fat', [{
      x: byDayFat.map(d => d.key),
      y: byDayFat.map(d => d.value),
      type: 'scatter',
      mode: 'lines+markers',
      line: { color: '#2E7D32' },
      marker: { color: '#2E7D32' }
    }], {
      ...mobileLayout,
      xaxis: { tickangle: isMobile ? -45 : -30, tickfont: { size: isMobile ? 9 : 11 } }
    }, mobileConfig);
    
    // Gráfico de bairros
    const bairros = groupBy(rows, r=> (r.bairro||'—'), _=>1, 'count')
      .sort((a,b)=> b.value-a.value)
      .slice(0, isMobile ? 5 : 8);
    Plotly.newPlot('chart-bairros', [{
      x: bairros.map(d => d.key),
      y: bairros.map(d => d.value),
      type: 'bar',
      marker: { color: '#C62828' }
    }], {
      ...mobileLayout,
      margin: { t: 20, l: 30, r: 20, b: isMobile ? 60 : 80 },
      xaxis: { 
        tickangle: isMobile ? -45 : -25, 
        tickfont: { size: isMobile ? 8 : 10 }
      }
    }, mobileConfig);
    
    // Gráfico de pagamento
    const pay = groupBy(rows, r=> (r.forma_pagamento||'—'), _=>1, 'count');
    Plotly.newPlot('chart-pagamento', [{
      labels: pay.map(d => d.key),
      values: pay.map(d => d.value),
      type: 'pie',
      hole: 0.4,
      textfont: { size: isMobile ? 10 : 12 }
    }], {
      ...mobileLayout,
      legend: { 
        orientation: 'h',
        y: isMobile ? -0.2 : -0.1,
        font: { size: isMobile ? 9 : 11 }
      }
    }, mobileConfig);
  }
  function renderTable(rows){
    const tb = q('#tbody'); tb.innerHTML='';
    rows.slice(0,500).forEach(r=>{
      const tr=document.createElement('tr'); const dt=new Date(r.data_hora_pedido).toLocaleString('pt-BR');
      tr.innerHTML = `<td>${dt}</td><td>${r.nome_cliente||''}</td><td>${r.bairro||''}</td><td>${r.forma_pagamento||''}</td><td>${r.status||''}</td><td>${currency(r.valor_total||0)}`;
      tb.appendChild(tr);
    });
  }
  function downloadCSV(rows){
    const headers = ['data_hora_pedido','nome_cliente','bairro','forma_pagamento','status','valor_total'];
    const lines = [headers.join(',')];
    rows.forEach(r=>{ const row = headers.map(h=> `"${String(r[h]??'').replaceAll('"','""')}"` ).join(','); lines.push(row); });
    const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pedidos_filtrados.csv'; a.click(); URL.revokeObjectURL(url);
  }
  // Cardápio Karaíba - Lista de pratos principais
  const CARDAPIO_KARAIBA = [
    'Almoço Karaíba', 'Marmitex',
    'Parmegiana Karaíba', 'Parmegiana',
    'Tropeiro Karaibano', 'Tropeiro',
    'Fish Grill', 'Tilápia Grelhada', 'Tilapia',
    'Frango 4 Queijos', 'Frango Quatro Queijos',
    'Chicken Grill', 'Frango Grelhado',
    'Strogonoff Frango', 'Strogonoff',
    'Filé à Cavalo', 'Filé a Cavalo',
    'Filé Molho Madeira', 'Filé Madeira',
    'Salada Karaíba',
    'Combo à la Carte', 'Combo La Carte',
    // Bebidas
    'Água sem gás', 'Água', 'Agua',
    'Água com gás', 'Água Gás',
    'Água tônica', 'Água Tonica', 'Tonica',
    'H2O Limoneto', 'Limoneto',
    'Coca Cola', 'Coca-Cola', 'Coca',
    'Coca Zero', 'Coca-Zero',
    'Mineiro Baby', 'Mineiro',
    'Fanta Uva', 'Fanta',
    'Guaraná', 'Guarana',
    'Schweppes',
    'Suco Limão', 'Suco de Limão',
    'Suco Abacaxi', 'Suco de Abacaxi', 'Abacaxi',
    'Suco Laranja', 'Suco de Laranja', 'Laranja',
    'Suco Caju', 'Suco de Caju', 'Caju',
    'Suco Maracujá', 'Suco de Maracujá', 'Maracuja',
    'Suco Laranja com Morango', 'Laranja Morango',
    'Suco Laranja com Acerola', 'Laranja Acerola',
    'Del Vale Pêssego', 'Del Vale Pessego', 'Pêssego', 'Pessego',
    'Del Vale Uva', 'Uva'
  ];

  function parseItens(itensString) {
    if (!itensString) return [];
    try {
      let itens = [];
      // Tenta diferentes formatos: JSON, separado por vírgula, etc.
      if (itensString.trim().startsWith('[') || itensString.trim().startsWith('{')) {
        itens = JSON.parse(itensString);
      } else {
        // Se for uma string simples separada por vírgula ou quebra de linha
        itens = itensString.split(/[,;\n]/).map(item => ({
          nome: item.trim(),
          quantidade: 1,
          preco: 0
        })).filter(item => item.nome);
      }
      
      // Filtra apenas itens do cardápio
      return itens.filter(item => {
        const nomeItem = (item.nome || item.toString()).toLowerCase();
        return CARDAPIO_KARAIBA.some(prato => 
          nomeItem.includes(prato.toLowerCase()) || 
          prato.toLowerCase().includes(nomeItem)
        );
      });
    } catch (e) {
      // Fallback: trata como string simples e filtra pelo cardápio
      const itens = itensString.split(/[,;\n]/).map(item => ({
        nome: item.trim(),
        quantidade: 1,
        preco: 0
      })).filter(item => item.nome);
      
      return itens.filter(item => {
        const nomeItem = item.nome.toLowerCase();
        return CARDAPIO_KARAIBA.some(prato => 
          nomeItem.includes(prato.toLowerCase()) || 
          prato.toLowerCase().includes(nomeItem)
        );
      });
    }
  }

  // Função para normalizar nomes dos pratos (agrupa variações)
  function normalizarNomePrato(nome) {
    const nomeClean = nome.toLowerCase().trim();
    
    // Mapeia variações para nomes principais
    const mapeamento = {
      'parmegiana karaíba': ['parmegiana', 'parmegiana karaiba'],
      'tropeiro karaibano': ['tropeiro'],
      'fish grill': ['tilápia grelhada', 'tilapia', 'tilapia grelhada'],
      'frango 4 queijos': ['frango quatro queijos', 'frango 4queijos'],
      'chicken grill': ['frango grelhado'],
      'strogonoff frango': ['strogonoff'],
      'filé à cavalo': ['filé a cavalo', 'file a cavalo', 'file à cavalo'],
      'filé molho madeira': ['filé madeira', 'file madeira', 'file molho madeira'],
      'almoço karaíba': ['marmitex', 'almoco karaiba'],
      'combo à la carte': ['combo la carte', 'combo'],
      'coca cola': ['coca-cola', 'coca'],
      'coca zero': ['coca-zero'],
      'água': ['agua'],
      'água com gás': ['agua com gas', 'água gás'],
      'água tônica': ['agua tonica', 'tonica'],
      'guaraná': ['guarana'],
      'suco de limão': ['suco limão', 'limão'],
      'suco de laranja': ['suco laranja', 'laranja'],
      'suco de abacaxi': ['suco abacaxi', 'abacaxi'],
      'suco de caju': ['suco caju', 'caju'],
      'suco de maracujá': ['suco maracuja', 'maracuja']
    };
    
    // Procura o nome principal correspondente
    for (const [principal, variacoes] of Object.entries(mapeamento)) {
      if (nomeClean.includes(principal) || variacoes.some(v => nomeClean.includes(v))) {
        return principal.charAt(0).toUpperCase() + principal.slice(1);
      }
    }
    
    // Se não encontrou mapeamento, retorna o nome original formatado
    return nome.charAt(0).toUpperCase() + nome.slice(1).toLowerCase();
  }

  function processItens(rows) {
    const itensCount = new Map();
    const itensReceita = new Map();
    
    rows.forEach(pedido => {
      if (!pedido.itens) return;
      
      const itens = parseItens(pedido.itens);
      const valorPedido = Number(pedido.valor_total) || 0;
      const numItens = itens.length || 1;
      const valorMedioPorItem = valorPedido / numItens;
      
      itens.forEach(item => {
        const nomeOriginal = item.nome || item.toString();
        const nomeNormalizado = normalizarNomePrato(nomeOriginal);
        const quantidade = Number(item.quantidade) || 1;
        
        // Conta quantidade
        itensCount.set(nomeNormalizado, (itensCount.get(nomeNormalizado) || 0) + quantidade);
        
        // Calcula receita (se tiver preço individual, usa ele, senão divide o valor do pedido)
        const precoItem = Number(item.preco) || valorMedioPorItem;
        itensReceita.set(nomeNormalizado, (itensReceita.get(nomeNormalizado) || 0) + (precoItem * quantidade));
      });
    });
    
    // Converte para array e ordena por quantidade
    return Array.from(itensCount.entries())
      .map(([nome, quantidade]) => ({
        nome,
        quantidade,
        receita: itensReceita.get(nome) || 0
      }))
      .sort((a, b) => b.quantidade - a.quantidade);
  }

  function renderItens(rows) {
    const itensData = processItens(rows); // Mostra todos os itens
    
    // Renderiza tabela
    const tbody = q('#tbodyItens');
    tbody.innerHTML = '';
    itensData.forEach((item, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">${item.nome}</td>
        <td>${item.quantidade}</td>
        <td>${currency(item.receita)}</td>
      `;
      tbody.appendChild(tr);
    });
    
    // Renderiza gráfico
    if (itensData.length > 0) {
      Plotly.newPlot('chart-itens', [{
        x: itensData.map(item => item.quantidade),
        y: itensData.map(item => item.nome.length > 25 ? item.nome.substring(0, 25) + '...' : item.nome),
        type: 'bar',
        orientation: 'h',
        marker: { color: '#1E88E5' }
      }], {
        margin: { t: 20, l: 120, r: 20, b: 40 },
        xaxis: { title: 'Quantidade Vendida' },
        paper_bgcolor: '#fff',
        plot_bgcolor: '#fff'
      }, { displayModeBar: false });
    }
    
    // Configura download CSV
    q('#downloadItens').onclick = () => {
      const headers = ['posicao', 'item', 'quantidade', 'receita'];
      const lines = [headers.join(',')];
      itensData.forEach((item, index) => {
        const row = [
          index + 1,
          `"${item.nome.replaceAll('"', '""')}"`,
          item.quantidade,
          item.receita.toFixed(2)
        ].join(',');
        lines.push(row);
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'itens_mais_pedidos.csv';
      a.click();
      URL.revokeObjectURL(url);
    };
  }

  function update(){
    const rows = applyFilters();
    renderKPIs(rows); renderCharts(rows); renderTable(rows); renderItens(rows);
    q('#download').onclick = ()=> downloadCSV(rows);
    
    // Re-configurar indicadores após renderizar tabelas
    setTimeout(setupTableScrollIndicators, 100);
  }

    // Pedidos de Hoje (listagem em cards)
  function renderHoje(rows){
    const list = q('#listHoje'); 
    list.innerHTML = '';
    const term = (q('#search').value||'').toLowerCase();
    
    const filteredRows = rows
      .filter(r=> !term || (String(r.nome_cliente||'').toLowerCase().includes(term) || String(r.bairro||'').toLowerCase().includes(term)))
      .sort((a,b)=> new Date(b.data_hora_pedido) - new Date(a.data_hora_pedido)); // Mais recentes primeiro
    
    // Mostra estado vazio se não há pedidos
    const emptyState = q('#emptyStateHoje');
    if (filteredRows.length === 0) {
      emptyState.style.display = 'block';
      list.style.display = 'none';
    } else {
      emptyState.style.display = 'none';
      list.style.display = 'grid';
      
      filteredRows.forEach(r => {
        const card = document.createElement('div');
        card.className = 'pedido-card';
        
        const dt = new Date(r.data_hora_pedido).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
        const status = r.status || 'Pendente';
        const tipoEntrega = r.tipo_entrega || r.entrega || 'Entrega';
        const statusClass = `status-${status.toLowerCase().replace(' ', '-').replace('ã', 'a')}`;
        
        // Determinar se é entrega ou retirada baseado em múltiplos campos
        let tipoDisplay = 'Entrega';
        if (tipoEntrega && (
          tipoEntrega.toLowerCase().includes('retirada') || 
          tipoEntrega.toLowerCase().includes('balcao') || 
          tipoEntrega.toLowerCase().includes('balcão') ||
          tipoEntrega.toLowerCase().includes('retirar')
        )) {
          tipoDisplay = 'Retirada';
        }
        
        const numeroPedido = r.codigo_pedido || 'S/N';
        
        // Determinar texto do botão baseado no tipo de entrega
        let textoBotaoEntrega = 'Enviar';
        let iconeBotaoEntrega = '';
        
        if (tipoDisplay === 'Retirada') {
          if (status.toLowerCase() === 'entregue') {
            textoBotaoEntrega = '✓ Retirado';
          } else if (status.toLowerCase() === 'saiu para entrega') {
            textoBotaoEntrega = '✓ Pronto';
          } else {
            textoBotaoEntrega = 'Pronto p/ Retirada';
          }
        } else {
          if (status.toLowerCase() === 'entregue') {
            textoBotaoEntrega = '✓ Entregue';
          } else if (status.toLowerCase() === 'saiu para entrega') {
            textoBotaoEntrega = '🚚 Saiu';
          } else {
            textoBotaoEntrega = 'Enviar';
          }
        }

        card.innerHTML = `
          <div class="card-top">
            <div class="pedido-info-top">
              <div class="pedido-time">${dt}</div>
              <div class="pedido-numero">#${numeroPedido}</div>
            </div>
            <div class="status-container">
              <div class="pedido-status ${statusClass}">
                ${status}
              </div>
              <div class="pedido-tipo">
                ${tipoDisplay}
              </div>
            </div>
          </div>
          
          <div class="pedido-value">${currency(r.valor_total||0)}</div>
          
          <div class="pedido-cliente">
            ${r.nome_cliente || 'Cliente não informado'}
          </div>
          
          <div class="pedido-info">
            <div class="info-item">
              <div class="info-label">Bairro</div>
              <div class="info-value">${r.bairro || 'Não informado'}</div>
            </div>
            <div class="info-item">
              <div class="info-label">Pagamento</div>
              <div class="info-value">${r.forma_pagamento || 'Não informado'}</div>
            </div>
          </div>
          
          <div class="pedido-actions">
            <button class="btn-action btn-confirmar" onclick="confirmarPedido('${numeroPedido}', this)" 
                    ${status.toLowerCase() === 'confirmado' ? 'disabled' : ''}>
              ${status.toLowerCase() === 'confirmado' ? '✓ Confirmado' : 'Confirmar'}
            </button>
            <button class="btn-action btn-entrega" onclick="enviarParaEntrega('${numeroPedido}', '${tipoDisplay}', this)"
                    ${status.toLowerCase() === 'entregue' || status.toLowerCase() === 'saiu para entrega' ? 'disabled' : ''}>
              ${textoBotaoEntrega}
            </button>
          </div>
        `;
        
        list.appendChild(card);
      });
    }
    
    q('#countHoje').textContent = filteredRows.length + ' pedidos';
  }
  
  // Função auxiliar para cores de status
  function getStatusColor(status) {
    const colors = {
      'Entregue': '#2E7D32',
      'Pendente': '#FF9800', 
      'Preparando': '#1E88E5',
      'Cancelado': '#C62828'
    };
    return colors[status] || '#667085';
  }
  async function refreshHoje(){
    const start = todayStr() + "T00:00:00";
    const end = todayStr() + "T23:59:59";
    const { data, error } = await supabase.from(SOURCE)
      .select('*')
      .gte('data_hora_pedido', start)
      .lte('data_hora_pedido', end)
      .order('data_hora_pedido', { ascending: true });
    if(error) { console.error(error); return; }
    const normalized = (data||[]).map(normalize);
    renderHoje(normalized);
  }
  q('#refreshHoje').addEventListener('click', refreshHoje);
  q('#search').addEventListener('input', refreshHoje);

  // Load & auto-refresh
  async function fetchAll(){
    console.log('fetchAll: Iniciando busca na tabela', SOURCE);
    let from=0, size=1000, out=[], done=false;
    while(!done){
      console.log('fetchAll: Buscando registros', from, 'a', from+size-1);
      const { data, error, count } = await supabase.from(SOURCE).select('*', { count:'exact' }).range(from, from+size-1);
      console.log('fetchAll: Resultado da busca', { data: data?.length, error, count });
      if(error) {
        console.error('Erro no fetchAll:', error);
        throw error;
      }
      out = out.concat(data||[]); from += size; if(!data.length || from >= (count||Infinity)) done = true;
    }
    console.log('fetchAll: Total de registros encontrados:', out.length);
    return out;
  }
  // Event listener para redimensionamento (responsividade)
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      if (DATA.length > 0) {
        const rows = applyFilters();
        renderCharts(rows);
        renderItens(rows);
        // Não precisa re-renderizar pedidos de hoje no resize pois são cards responsivos
      }
    }, 300);
  });

  // Função para gerenciar indicadores de scroll das tabelas
  function setupTableScrollIndicators() {
    const tableScrolls = document.querySelectorAll('.table-scroll');
    
    tableScrolls.forEach(scroll => {
      const container = scroll.closest('.table-container');
      const indicator = container.querySelector('.scroll-indicator');
      
      function updateScrollIndicator() {
        const canScrollRight = scroll.scrollLeft < (scroll.scrollWidth - scroll.clientWidth - 10);
        
        if (canScrollRight) {
          container.classList.add('scrollable');
          scroll.classList.add('has-more');
        } else {
          container.classList.remove('scrollable');
          scroll.classList.remove('has-more');
        }
      }
      
      // Evento de scroll
      scroll.addEventListener('scroll', updateScrollIndicator);
      
      // Verificação inicial
      setTimeout(updateScrollIndicator, 100);
      
      // Re-verificar quando a janela redimensiona
      window.addEventListener('resize', updateScrollIndicator);
    });
  }

  async function init(){
    console.log('Iniciando função init()...');
    try{
      console.log('Definindo status como carregando...');
      q('#status').textContent = 'Carregando…';
      console.log('Fazendo fetchAll()...');
      const raw = await fetchAll();
      console.log('Dados recebidos:', raw?.length, 'registros');
      DATA = raw.map(normalize);
      console.log('Dados normalizados:', DATA?.length, 'registros');
      q('#status').textContent = `Conectado • ${DATA.length} pedidos`;
      console.log('Executando hydrateFilters, update e refreshHoje...');
      hydrateFilters(); update(); refreshHoje();
      
      // Configurar indicadores de scroll das tabelas
      setTimeout(setupTableScrollIndicators, 500);
      
      if (window.timerHoje) clearInterval(window.timerHoje);
      window.timerHoje = setInterval(refreshHoje, 20000); // 20s
    }catch(e){
      console.error('Erro na função init():', e);
      q('#status').textContent = 'Erro de leitura';
      alert('Erro Supabase: '+(e.message||e));
    }
  }

  // Função de logout
  function logout() {
    showLogoutModal();
  }
  
  // Mostrar modal de logout
  function showLogoutModal() {
    const modal = document.getElementById('logoutModal');
    modal.style.display = 'flex';
    
    // Focus no botão cancelar para acessibilidade
    setTimeout(() => {
      document.getElementById('cancelLogout').focus();
    }, 100);
  }
  
  // Esconder modal de logout
  function hideLogoutModal() {
    const modal = document.getElementById('logoutModal');
    modal.style.display = 'none';
  }
  
  // Confirmar logout
  function confirmLogout() {
    localStorage.removeItem('karaiba_user');
    window.location.href = 'login.html';
  }

  // Event listeners para logout
  document.getElementById('logoutBtn').addEventListener('click', logout);
  document.getElementById('cancelLogout').addEventListener('click', hideLogoutModal);
  document.getElementById('confirmLogout').addEventListener('click', confirmLogout);
  
  // Fechar modal ao clicar fora dele
  document.getElementById('logoutModal').addEventListener('click', (e) => {
    if (e.target.id === 'logoutModal') {
      hideLogoutModal();
    }
  });
  
  // Fechar modal com ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('logoutModal');
      if (modal.style.display === 'flex') {
        hideLogoutModal();
      }
    }
  });

  // Mostrar nome do usuário logado (opcional)
  if (currentUser && currentUser.usuario) {
    document.getElementById('logoutBtn').title = `Sair (${currentUser.usuario})`;
  }

  // Funções dos botões de ação dos pedidos
  async function confirmarPedido(numeroPedido, botao) {
    try {
      console.log('Confirmando pedido:', numeroPedido);
      botao.disabled = true;
      botao.textContent = 'Confirmando...';
      
      // Atualizar no Supabase
      const { error } = await supabase
        .from(SOURCE)
        .update({ status: 'Confirmado' })
        .eq('codigo_pedido', numeroPedido);
      
      if (error) {
        console.error('Erro ao confirmar pedido:', error);
        botao.disabled = false;
        botao.textContent = 'Confirmar';
        alert('Erro ao confirmar pedido. Tente novamente.');
        return;
      }
      
      botao.textContent = '✓ Confirmado';
      
      // Atualizar a lista
      setTimeout(() => {
        refreshHoje();
      }, 1000);
      
    } catch (error) {
      console.error('Erro:', error);
      botao.disabled = false;
      botao.textContent = 'Confirmar';
      alert('Erro ao confirmar pedido.');
    }
  }
  
  async function enviarParaEntrega(numeroPedido, tipoEntrega, botao) {
    try {
      console.log('Processando pedido:', numeroPedido, 'Tipo:', tipoEntrega);
      botao.disabled = true;
      
      let novoStatus = '';
      let textoProcessando = '';
      
      if (tipoEntrega === 'Retirada') {
        novoStatus = 'Saiu para entrega'; // Mantém o mesmo status, mas o texto será diferente
        textoProcessando = 'Preparando...';
      } else {
        novoStatus = 'Saiu para entrega';
        textoProcessando = 'Enviando...';
      }
      
      botao.textContent = textoProcessando;
      
      // Atualizar no Supabase
      const { error } = await supabase
        .from(SOURCE)
        .update({ status: novoStatus })
        .eq('codigo_pedido', numeroPedido);
      
      if (error) {
        console.error('Erro ao processar pedido:', error);
        botao.disabled = false;
        botao.textContent = tipoEntrega === 'Retirada' ? 'Pronto p/ Retirada' : 'Enviar';
        alert('Erro ao processar pedido. Tente novamente.');
        return;
      }
      
      if (tipoEntrega === 'Retirada') {
        botao.textContent = '✓ Pronto';
      } else {
        botao.textContent = '🚚 Saiu';
      }
      
      // Atualizar a lista
      setTimeout(() => {
        refreshHoje();
      }, 1000);
      
    } catch (error) {
      console.error('Erro:', error);
      botao.disabled = false;
      botao.textContent = tipoEntrega === 'Retirada' ? 'Pronto p/ Retirada' : 'Enviar';
      alert('Erro ao processar pedido.');
    }
  }

  init();
  } // Fim da função initApp
</script>
</body>
</html>
