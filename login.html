<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Login - Painel Karaíba</title>
  <!-- Login System Ready -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#C62828">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Karaíba">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Karaíba">
  
  <!-- Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="152x152" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="167x167" href="/favicon.ico">
  <style>
    /* RESET E BASE */
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;margin:0;padding:0}
    html,body{height:100%;font-family:Inter,system-ui,sans-serif}
    
    /* VARIÁVEIS CSS */
    :root{
      --red:#C62828;
      --red-700:#B71C1C;
      --green:#2E7D32;
      --text:#2c3e50;
      --muted:#64748b;
      --border:#e2e8f0;
      --bg:#f8fafc;
      --card:#ffffff;
    }
    
    /* CONTAINER DE LOGIN */
    body{
      background:linear-gradient(135deg, var(--red) 0%, var(--red-700) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:20px;
    }
    
    /* CARD DE LOGIN */
    .login-card{
      background:var(--card);
      border-radius:20px;
      padding:40px;
      box-shadow:0 20px 40px rgba(0,0,0,0.1);
      width:100%;
      max-width:400px;
      text-align:center;
    }
    
    /* LOGO */
    .logo{
      width:80px;
      height:80px;
      margin:0 auto 30px;
      background-image:url('https://i.ibb.co/Q37KgBh3/Ativo-1-2x.png');
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
    }
    
    /* TÍTULO */
    .login-title{
      font-size:28px;
      font-weight:800;
      color:var(--text);
      margin-bottom:8px;
    }
    
    .login-subtitle{
      font-size:16px;
      color:var(--muted);
      margin-bottom:32px;
    }
    
    /* FORMULÁRIO */
    .form-group{
      margin-bottom:20px;
      text-align:left;
    }
    
    .form-label{
      display:block;
      font-size:14px;
      font-weight:600;
      color:var(--text);
      margin-bottom:8px;
    }
    
    .form-input{
      width:100%;
      padding:16px 20px;
      border:2px solid var(--border);
      border-radius:12px;
      font-size:16px;
      background:#fff;
      transition:all 0.2s ease;
      outline:none;
    }
    
    .form-input:focus{
      border-color:var(--red);
      box-shadow:0 0 0 3px rgba(198,40,40,0.1);
      transform:scale(1.02);
    }
    
    /* BOTÃO DE LOGIN */
    .login-btn{
      width:100%;
      background:var(--red);
      color:#fff;
      border:none;
      padding:18px 24px;
      border-radius:12px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s ease;
      margin-top:8px;
    }
    
    .login-btn:hover{
      background:var(--red-700);
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(198,40,40,0.3);
    }
    
    .login-btn:active{
      transform:translateY(0);
    }
    
    .login-btn:disabled{
      background:var(--muted);
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }
    
    /* MENSAGENS */
    .message{
      padding:12px 16px;
      border-radius:8px;
      font-size:14px;
      font-weight:600;
      margin-bottom:20px;
      text-align:center;
    }
    
    .message.error{
      background:#fee2e2;
      color:#dc2626;
      border:1px solid #fecaca;
    }
    
    .message.success{
      background:#dcfce7;
      color:#16a34a;
      border:1px solid #bbf7d0;
    }
    
    /* LOADING ANIMATION */
    .loading{
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid #ffffff;
      border-radius:50%;
      border-top-color:transparent;
      animation:spin 1s ease-in-out infinite;
      margin-right:8px;
    }
    
    @keyframes spin{
      to{transform:rotate(360deg)}
    }
    
    /* RESPONSIVO MOBILE */
    @media(max-width:480px){
      .login-card{
        padding:30px 20px;
        margin:10px;
      }
      
      .login-title{
        font-size:24px;
      }
      
      .login-subtitle{
        font-size:14px;
      }
      
      .form-input{
        padding:14px 16px;
        font-size:16px; /* Evita zoom no iOS */
      }
      
      .login-btn{
        padding:16px 20px;
      }
    }
    
    /* FOOTER */
    .login-footer{
      margin-top:30px;
      padding-top:20px;
      border-top:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="login-card">
    <div class="logo"></div>
    
    <h1 class="login-title">Bem-vindo</h1>
    <p class="login-subtitle">Faça login para acessar o painel gerencial</p>
    
    <div id="message" class="message" style="display:none;"></div>
    
    <form id="loginForm">
      <div class="form-group">
        <label for="username" class="form-label">Usuário</label>
        <input type="text" id="username" name="username" class="form-input" required autocomplete="username">
      </div>
      
      <div class="form-group">
        <label for="password" class="form-label">Senha</label>
        <input type="password" id="password" name="password" class="form-input" required autocomplete="current-password">
      </div>
      
      <button type="submit" id="loginBtn" class="login-btn">
        Entrar
      </button>
    </form>
    
    <div class="login-footer">
      <strong>Karaíba Restaurante</strong><br>
      Sistema de gestão de pedidos
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
    
    // Configuração do Supabase (mesmas credenciais do dashboard)
    const supabase = createClient("https://dbepscombakzdvruuxav.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRiZXBzY29tYmFremR2cnV1eGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzODg5OTEsImV4cCI6MjA2Njk2NDk5MX0.vahd7AyhmuJ22EzpapV237jPQPh4UjL-gt6QMvVRozs", { db: { schema:'public' } });
    
    // Elementos do DOM
    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const messageDiv = document.getElementById('message');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    
    // Verificar se já está logado
    function checkAuth() {
      const user = localStorage.getItem('karaiba_user');
      if (user) {
        window.location.href = '/';
      }
    }
    
    // Mostrar mensagem
    function showMessage(text, type = 'error') {
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
      
      // Auto-esconder após 5 segundos
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 5000);
    }
    
    // Estado de loading
    function setLoading(loading) {
      loginBtn.disabled = loading;
      if (loading) {
        loginBtn.innerHTML = '<span class="loading"></span>Entrando...';
      } else {
        loginBtn.innerHTML = 'Entrar';
      }
    }
    
    // Função de login
    async function handleLogin(e) {
      e.preventDefault();
      
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      
      if (!username || !password) {
        showMessage('Por favor, preencha todos os campos.');
        return;
      }
      
      setLoading(true);
      messageDiv.style.display = 'none';
      
      try {
        console.log('Tentando login com:', { usuario: username, senha: '***' });
        
        // Primeiro tentar com 'usuario' e 'senha'
        let { data, error, count } = await supabase
          .from('usuarios_painel_karaiba')
          .select('*', { count: 'exact' })
          .eq('usuario', username)
          .eq('senha', password);
        
        console.log('Primeira tentativa (usuario/senha):', { data, error, count });
        
        // Se deu erro ou não encontrou, tentar com 'login' e 'senha'
        if (error || count === 0) {
          console.log('Tentando segunda busca (login/senha)...');
          const result = await supabase
            .from('usuarios_painel_karaiba')
            .select('*', { count: 'exact' })
            .eq('login', username)
            .eq('senha', password);
          
          console.log('Segunda tentativa (login/senha):', result);
          data = result.data;
          error = result.error;
          count = result.count;
        }
        
        if (error) {
          showMessage('Erro ao conectar com o servidor. Tente novamente.');
          console.error('Erro Supabase:', error);
          return;
        }
        
        // Se encontrou algum registro, login é válido
        if (count > 0) {
          // Login bem-sucedido - salvar dados básicos
          const userData = {
            usuario: username,
            loginTime: new Date().toISOString()
          };
          
          // Salvar dados do usuário no localStorage
          localStorage.setItem('karaiba_user', JSON.stringify(userData));
          
          showMessage('Login realizado com sucesso!', 'success');
          
          // Redirecionar para o dashboard após 1 segundo
          setTimeout(() => {
            window.location.href = '/';
          }, 1000);
        } else {
          showMessage('Usuário ou senha incorretos.');
        }
        
      } catch (error) {
        console.error('Erro no login:', error);
        showMessage('Erro interno. Tente novamente mais tarde.');
      } finally {
        setLoading(false);
      }
    }
    
    // Event listeners
    loginForm.addEventListener('submit', handleLogin);
    
    // Permitir Enter nos campos
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        passwordInput.focus();
      }
    });
    
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogin(e);
      }
    });
    
    // Verificar autenticação ao carregar a página
    checkAuth();
    
    // Focus no campo de usuário
    usernameInput.focus();
  </script>
</body>
</html>